# Phase 3 å¼€å‘è·¯çº¿å›¾ï¼šæ•°æ®åº“é›†æˆä¸Žå¼•æ“Žå¢žå¼º

## 1. ç›®æ ‡æ¦‚è¿° (Overview)

Phase 3 çš„æ ¸å¿ƒç›®æ ‡æ˜¯æž„å»ºç¨³å¥çš„æœ¬åœ°æ•°æ®æŒä¹…åŒ–å±‚ï¼Œè§£å†³é‡å¤ä¸‹è½½ç›¸åŒæ•°æ®çš„é—®é¢˜ï¼Œå¹¶åŸºäºŽä¸°å¯Œçš„æ•°æ®ç»´åº¦å¤§å¹…æ‰©å¼ å›žæµ‹å¼•æ“Žçš„é£ŽæŽ§ã€ä»¿çœŸçœŸå®žåº¦ä¸Žè¯„ä»·èƒ½åŠ›ã€‚
**ä¼˜å…ˆçº§è°ƒæ•´**ï¼šæˆ‘ä»¬å°†é¦–å…ˆå®Œæˆ **æ•°æ®åº“åŸºç¡€è®¾æ–½** çš„æ­å»ºä»¥è§£å†³æ•ˆçŽ‡ç“¶é¢ˆï¼›éšåŽå¼•å…¥ **æ•°æ®å¢žå¼ºä¸ŽæŒ‡æ ‡åº“**ï¼›æœ€åŽé€šè¿‡ **å¼•æ“Žå¼ºåŒ–ä¸Žä¸“ä¸šåŒ–æ‰“ç£¨** è¡¥é½ä¸Žä¸“ä¸šæ¡†æž¶çš„å·®è·ã€‚

## 2. æ ¸å¿ƒåŠŸèƒ½è§„åˆ’ (Core Features)

### 2.1 [P0] æ•°æ®åº“é›†æˆä¸Žæ•°æ®æŒä¹…åŒ– (Database & Persistence)
**å‚è€ƒ**ï¼šSQLAlchemy ORM æ¨¡å¼ä¸Ž Repository ä»“åº“æ¨¡å¼ã€‚
**çŽ°çŠ¶**ï¼šæ¯æ¬¡å›žæµ‹éœ€å®žæ—¶æ‹‰å– K çº¿ï¼Œå—é™äºŽäº¤æ˜“æ‰€é¢‘çŽ‡é™åˆ¶ï¼ˆRate Limitï¼‰ï¼Œä¸”æ— æ³•å­˜å‚¨è‡ªå®šä¹‰éžæ ‡å‡†æ•°æ®ï¼ˆå¦‚èµ„é‡‘è´¹çŽ‡ï¼‰ã€‚
**ç›®æ ‡**ï¼šå®žçŽ°æ•°æ®çš„â€œä¸€æ¬¡é‡‡é›†ï¼Œæ°¸ä¹…ä½¿ç”¨â€ï¼Œå¹¶ä¸ºè¿›é˜¶åˆ†æžæä¾›é«˜æ€§èƒ½æŸ¥è¯¢åº•åº§ã€‚

- **[T1] åŸºç¡€è®¾æ–½æ­å»º**
    - å®žçŽ° `src/database/database.py`: è¿žæŽ¥ç®¡ç†åŠ WAL å¹¶å‘æ¨¡å¼é…ç½®ã€‚
    - å®žçŽ° `src/database/models.py`: å®šä¹‰ `Candlestick`, `FundingRate`, `Sentiment` ç­‰ ORM æ¨¡åž‹ã€‚
- **[T2] æ•°æ®ä»“åº“å±‚å®žçŽ° (Repository)**
    - å¼€å‘ `MarketDataRepository`: æ”¯æŒâ€œé€æ˜ŽåŒæ­¥ (Lazy Sync)â€â€”â€”ä¼˜å…ˆæŸ¥åº“ï¼Œç¼ºå¤±æ—¶è¡¥å…¨å¹¶å›žå†™ã€‚
    - å®žçŽ° API è·¯ç”± `POST /api/klines/sync`: æ”¯æŒæ‰‹åŠ¨è§¦å‘ç‰¹å®šèŒƒå›´çš„æ•°æ®åŒæ­¥ã€‚
- **[T3] å¢žé‡è¡¥å…¨é€»è¾‘**
    - æ”¹é€  `BinanceClient` è§£æžå™¨ï¼Œç¡®ä¿ 11+ åŽŸå§‹å­—æ®µæ— æŸå­˜åº“ï¼Œå¹¶æ”¯æŒæ ¹æ®åº“ä¸­æœ€åŽä¸€æ¡è®°å½•è‡ªåŠ¨è¡¥å…¨ã€‚

### 2.2 [P1] æ•°æ®å¢žå¼ºä¸ŽæŒ‡æ ‡åº“ (Data Enrichment & Indicators)
**å‚è€ƒ**ï¼šå¸å®‰åˆçº¦æŽ¥å£ (Binance Futures API) åŠ TA-Lib/Backtrader æŒ‡æ ‡åº“ã€‚
**çŽ°çŠ¶**ï¼šç›®å‰ç­–ç•¥èƒ½è§åº¦ä»…é™äºŽ O/H/L/C/V åŸºç¡€å­—æ®µï¼Œç¼ºä¹å¸‚åœºæƒ…ç»ªä¸Žè¡ç”Ÿå“ç»´åº¦ã€‚

- **[T4] åˆçº¦è¡ç”Ÿæ•°æ®å¯¹æŽ¥**
    - å®žçŽ°åŽ†å²èµ„é‡‘è´¹çŽ‡ (`funding_rates`) çš„é‡‡é›†ä¸Žå…¥åº“ã€‚
    - å®žçŽ°å¸‚åœºæƒ…ç»ªï¼ˆå…¨å±€å¤šç©ºæ¯”ã€å¤§æˆ·æŒä»“æ¯”ï¼‰çš„åŽ†å²æ•°æ®è¿½è¸ªã€‚
- **[T5] æŒ‡æ ‡åº“æ·±åº¦æ‰©å¼ **
    - **æŠ€æœ¯æŒ‡æ ‡**: ADX, Ichimoku, Stochastic, Williams %R, CCI, OBVã€‚
    - **æƒ…ç»ªæŒ‡æ ‡**: åŸºäºŽå¤šç©ºæ¯”åˆ†æ­§çš„é€†å‘æŒ‡æ ‡å¼•æ“Žã€‚
- **[T6] æ•°æ®è¿›é˜¶å¤„ç†é€»è¾‘**
    - å®žçŽ° **æ•°æ®é‡é‡‡æ · (Resampling)**: æ”¯æŒä»Ž 1min åŸºç¡€æ•°æ®åŠ¨æ€åˆæˆä»»æ„é«˜å‘¨æœŸçº§åˆ«ã€‚
    - å®žçŽ° **å¤šå‘¨æœŸåŒæ­¥ (Multi-Timeframe)**: åœ¨åŒä¸€å›žæµ‹è¿›ç¨‹ä¸­ç²¾å‡†å¯¹é½ä¸åŒå‘¨æœŸã€‚

### 2.3 [P1] äº¤æ˜“å¼•æ“Žå¼ºåŒ– (Engine Fortification)
**å‚è€ƒ**ï¼šBacktrader çš„ `Sizer` ä½“ç³»ä¸Žå¤æ‚è®¢å•æ’®åˆé€»è¾‘ã€‚
**çŽ°çŠ¶**ï¼šä»…æ”¯æŒå›ºå®šä»“ä½ï¼Œç¼ºä¹è‡ªåŠ¨åŒ–é£Žé™©æŽ§åˆ¶ä¸Žä¸“ä¸šä»¿çœŸæ¨¡åž‹ã€‚

- **[T7] Sizer èµ„é‡‘ç®¡ç†ä½“ç³»**
    - å®žçŽ° `BaseSizer` æŠ½è±¡åŠå…¶å­ç±»ï¼š`FixedSize`, `PercentSize`, `RiskSize` (åŸºäºŽ ATR)ã€‚
    - åœ¨ç­–ç•¥å±‚æä¾› `setsizer()` APIã€‚
- **[T8] é«˜çº§é£ŽæŽ§è®¢å•**
    - å®žçŽ° `TrailingStop` (ç§»åŠ¨æ­¢æŸ) é€»è¾‘ï¼Œæ”¯æŒ Broker ç«¯çš„åŠ¨æ€è¿½è¸ªè°ƒæ•´ã€‚
    - å®žçŽ° `Bracket Order` (æŒ‚é’©è®¢å•) è‡ªåŠ¨åŒ–æµæ°´çº¿ã€‚
- **[T9] ä¸“ä¸šä»¿çœŸåº¦æå‡**
    - **æ¨¡åž‹æ‰©å±•**: å®žçŽ° `FixedSlippage` / `PercentSlippage` æ»‘ç‚¹æ¨¡åž‹ã€‚
    - **æˆæœ¬æ ¸ç®—**: æ”¯æŒæŒ‰å¸ç§/æˆäº¤é¢é…ç½® Maker/Taker è´¹çŽ‡ã€‚
    - **åˆçº¦ä»¿çœŸ**: å®žçŽ°åŸºæœ¬çš„æ æ†ç®¡ç†ä¸Žèµ„é‡‘è´¹ç»“ç®—é€»è¾‘ã€‚

### 2.4 [P2] ä¸šç»©è¯„ä»·ç³»ç»Ÿ (Analyzers & Evaluation)
**å‚è€ƒ**ï¼šBacktrader çš„ `Analyzers` è¯„ä»·ç³»ç»Ÿã€‚
**çŽ°çŠ¶**ï¼šå›žæµ‹ç»“æŸä»…æœ‰å‡€å€¼æ›²çº¿ï¼Œæ— æ³•é‡åŒ–ç­–ç•¥ä¼˜åŠ£ã€‚

- **[T10] æ ‡å‡†åŒ–åˆ†æžå™¨é›†**
    - å®žçŽ° Sharpe Ratio, Max Drawdown, Win Rate, Profit Factor ç­‰æŒ‡æ ‡çš„è‡ªåŠ¨è®¡ç®—ã€‚
- **[T11] åŸºå‡†å¯¹æ¯” (Benchmark)**
    - æ”¯æŒåœ¨ equity curve ä¸­å¼•å…¥ BTC æˆ–ä¸»æµæŒ‡æ•°ä½œä¸ºå¯¹æ ‡åŸºå‡†ã€‚

---

## 3. å®žæ–½é˜¶æ®µ (Implementation Phasing)

1.  **Phase 3.1 (Foundation)** [ðŸš§ è¿›è¡Œä¸­]: æ•°æ®åº“åŸºç¡€è®¾æ–½ä¸Žå¢žé‡åŒæ­¥é€»è¾‘ã€‚
2.  **Phase 3.2 (Data Enrichment)**: è¡ç”Ÿå“æ•°æ®å¯¹æŽ¥ä¸ŽæŒ‡æ ‡åº“å¤§å¹…æ‰©å¼ ã€‚
3.  **Phase 3.3 (Engine & Risk)**: Sizer ä½“ç³»ã€é«˜çº§è®¢å•ä¸Žæ»‘ç‚¹æ¨¡åž‹ã€‚
4.  **Phase 3.4 (Polishing)**: æ€§èƒ½åˆ†æžå™¨ä¸Žå¤šå‘¨æœŸæ•°æ®å¤„ç†ã€‚

---

## é™„å½•ï¼šå…³é”®æŠ€æœ¯å†³ç­–è¯´æ˜Ž (Technical Decisions Appendix)

### D3: æ•°æ®åº“å¹¶å‘æ¨¡åž‹é€‰æ‹©
> **å†³ç­–**ï¼šé‡‡ç”¨ **SQLite + WAL (Write-Ahead Logging) æ¨¡å¼**ã€‚
> **èƒŒæ™¯**ï¼šåœ¨åŽå°åŒæ­¥æ•°æ®ï¼ˆå†™å…¥ï¼‰çš„åŒæ—¶ï¼Œç”¨æˆ·å¯èƒ½æ­£åœ¨è¿›è¡Œç­–ç•¥å›žæµ‹ï¼ˆè¯»å–ï¼‰ã€‚
> **è§£é‡Š**ï¼šWAL æ¨¡å¼å…è®¸ä¸€ä¸ªå†™è€…ä¸é˜»å¡žå¤šä¸ªè¯»è€…ï¼Œæžå¤§æå‡äº†å›žæµ‹ä¸ŽåŒæ­¥ä»»åŠ¡å¹¶å‘æ—¶çš„å“åº”é€Ÿåº¦ã€‚æ­¤å¤–ï¼Œç”±äºŽé‡åŒ–æ•°æ®é€šå¸¸æ˜¯é¡ºåºå¢žé•¿ä¸”ä¸€æ¬¡å†™å…¥å¤šæ¬¡è¯»å–ï¼ŒSQLite çš„æ€§èƒ½æŸè€—å¯å¿½ç•¥ä¸è®¡ã€‚

### D4: çµæ´»çš„ä»“ä½è®¡ç®— (Flexible Sizing)
> **å†³ç­–**ï¼šå¼•å…¥ç‹¬ç«‹äºŽè®¢å•çš„ **Sizer æŠ½è±¡å±‚**ã€‚
> **è§£é‡Š**ï¼šé€šè¿‡å°†â€œäº¤æ˜“ä»€ä¹ˆâ€ (Strategy) ä¸Žâ€œäº¤æ˜“å¤šå°‘â€ (Sizer) è§£è€¦ï¼Œç”¨æˆ·åªéœ€ç¼–å†™ä¸€æ¬¡é€»è¾‘ï¼Œå³å¯åœ¨ä¸åŒçš„èµ„äº§è§„æ¨¡ä¸‹é€šè¿‡é…ç½® Sizer æ¥é€‚é…èµ„é‡‘ç®¡ç†æ–¹æ¡ˆï¼Œæ— éœ€åœ¨ç­–ç•¥ä»£ç ä¸­ç¡¬ç¼–ç ä¸‹å•æ•°é‡ã€‚

### D5: å¤šå‘¨æœŸæ•°æ®å¯¹é½
> **å†³ç­–**ï¼šé‡‡ç”¨ **è‡ªé€‚åº”æ—¶é—´æˆ³åˆå¹¶ (Dynamic Timestamp Merging)**ã€‚
> **è§£é‡Š**ï¼šå½“è¿è¡Œ 5min ç­–ç•¥å¹¶å‚è€ƒ 1h å‘¨æœŸæ—¶ï¼Œç³»ç»Ÿä¼šç¡®ä¿ 1h çš„ Bar ä»…åœ¨å…¶å‘¨æœŸç»“æŸçš„æ—¶é—´ç‚¹å¯¹ç­–ç•¥å¯è§ï¼Œä»Žè€Œä¸¥æ ¼æœç»â€œæœªæ¥å‡½æ•°â€é£Žé™©ã€‚

---

## æ ¸å¿ƒæž¶æž„æ¼”è¿›å›¾

```mermaid
graph TB
    subgraph Storage [æ•°æ®å­˜å‚¨å±‚]
        DB[(SQLite å¸‚åœºæ•°æ®åº“)]
        Repo[å¸‚åœºæ•°æ®ä»“åº“]
        Model[SQLAlchemy æ¨¡åž‹å®šä¹‰]
    end

    subgraph Service [åŽç«¯æœåŠ¡å±‚]
        Client[å¸å®‰ API å®¢æˆ·ç«¯]
        SyncTask[æ•°æ®åŒæ­¥ç®¡ç†å™¨]
        Handler[æ•°æ®é‡é‡‡æ ·å¤„ç†å™¨]
    end

    subgraph Engine [å›žæµ‹å¼•æ“Žå¢žå¼º]
        Broker[çŽ°ä»£ç»çºªå•†æ ¸å¿ƒ]
        Sizer[èµ„é‡‘ç®¡ç†ç»„ä»¶]
        Order[é«˜çº§è®¢å•é€»è¾‘]
        Analyzer[ä¸šç»©è¯„ä¼°åˆ†æžå™¨]
    end

    %% è¿žæŽ¥å…³ç³»
    Client --> SyncTask
    SyncTask --> Repo
    Repo --> DB
    
    Repo --> Handler
    Handler -->|å¯¹é½åŽçš„æ•°æ®æµ| Broker
    
    Broker --> Sizer
    Broker --> Order
    Broker --> Analyzer
```
