# Phase 3 å¼€å‘è·¯çº¿å›¾ï¼šæ•°æ®åº“é›†æˆä¸Žå¼•æ“Žå¢žå¼º

> **æœ€åŽæ›´æ–°**: 2025-12-26
> **çŠ¶æ€**: Phase 3.3 å·²å®Œæˆ âœ…

## 1. ç›®æ ‡æ¦‚è¿° (Overview)

Phase 3 çš„æ ¸å¿ƒç›®æ ‡æ˜¯æž„å»ºç¨³å¥çš„æœ¬åœ°æ•°æ®æŒä¹…åŒ–å±‚ï¼Œè§£å†³é‡å¤ä¸‹è½½ç›¸åŒæ•°æ®çš„é—®é¢˜ï¼Œå¹¶åŸºäºŽä¸°å¯Œçš„æ•°æ®ç»´åº¦å¤§å¹…æ‰©å¼ å›žæµ‹å¼•æ“Žçš„é£ŽæŽ§ã€ä»¿çœŸçœŸå®žåº¦ä¸Žè¯„ä»·èƒ½åŠ›ã€‚

## 2. æ ¸å¿ƒåŠŸèƒ½è§„åˆ’ (Core Features)

### 2.1 [P0] æ•°æ®åº“é›†æˆä¸Žæ•°æ®æŒä¹…åŒ– âœ… å·²å®Œæˆ

| ä»»åŠ¡ | çŠ¶æ€ | è¯´æ˜Ž |
|------|------|------|
| T1: åŸºç¡€è®¾æ–½æ­å»º | âœ… | SQLite + WAL æ¨¡å¼, ORM æ¨¡åž‹å®šä¹‰ |
| T2: æ•°æ®ä»“åº“å±‚ | âœ… | MarketDataRepository é€æ˜ŽåŒæ­¥ |
| T3: å¢žé‡è¡¥å…¨é€»è¾‘ | âœ… | è‡ªåŠ¨æ£€æµ‹å¹¶è¡¥å…¨ç¼ºå¤±æ•°æ® |

### 2.2 [P1] æ•°æ®å¢žå¼ºä¸ŽæŒ‡æ ‡åº“ âœ… å·²å®Œæˆ

| ä»»åŠ¡ | çŠ¶æ€ | è¯´æ˜Ž |
|------|------|------|
| T4: åˆçº¦è¡ç”Ÿæ•°æ® | âœ… | èµ„é‡‘è´¹çŽ‡ã€å¤šç©ºæ¯”å…¥åº“ |
| T5: æŒ‡æ ‡åº“æ·±åº¦æ‰©å¼  | âœ… | ADX, Ichimoku, Stochastic, CCI, OBV ç­‰ |
| T6: å¤šå‘¨æœŸåŒæ­¥ | âœ… | Resampler + TimeframeAlignedFeed |

### 2.3 [P1] äº¤æ˜“å¼•æ“Žå¼ºåŒ– âœ… å·²å®Œæˆ

| ä»»åŠ¡ | çŠ¶æ€ | è¯´æ˜Ž |
|------|------|------|
| T7: Sizer èµ„é‡‘ç®¡ç† | âœ… | FixedSize, PercentSize, AllIn, RiskSize |
| T8: é«˜çº§é£ŽæŽ§è®¢å• | âœ… | TrailingStop, Bracket Order, OCO |
| T9: ä¸“ä¸šä»¿çœŸåº¦ | âœ… | æ»‘ç‚¹æ¨¡åž‹ã€æ‰‹ç»­è´¹æ¨¡åž‹ |
| T9.1: AI æç¤ºè¯æ›´æ–° | âœ… | setsizer/trailing_stop/bracket API æ–‡æ¡£ |

### 2.4 [P2] ä¸šç»©è¯„ä»·ç³»ç»Ÿ âœ… å·²å®Œæˆ

| ä»»åŠ¡ | çŠ¶æ€ | è¯´æ˜Ž |
|------|------|------|
| T10: æ ‡å‡†åŒ–åˆ†æžå™¨é›† | âœ… | Sharpe, Sortino, Calmar, DD, Returns, Trades |
| T11: åŸºå‡†å¯¹æ¯” | â­ï¸ | è·³è¿‡ï¼ˆæœªæ¥æŒ‰éœ€å®žçŽ°ï¼‰ |

### 2.5 [P2] ç”¨æˆ·é…ç½®å¢žå¼º âœ… å·²å®Œæˆ

| ä»»åŠ¡ | çŠ¶æ€ | è¯´æ˜Ž |
|------|------|------|
| T12: ç­–ç•¥å†…èµ„é‡‘é…ç½® | âœ… | `self.set_capital()` API |
| T13: æ—¥å¿—ç³»ç»Ÿå¢žå¼º | âœ… | Bracket/OCO/Trail è®¢å•è¯¦ç»†æ—¥å¿— |

### 2.6 [P3] å¯è§†åŒ–å¢žå¼º ðŸ“‹ è§„åˆ’ä¸­

> è¯¦è§ [STEP5_VISUALIZATION_ENHANCEMENT.md](./STEP5_VISUALIZATION_ENHANCEMENT.md)

| ä»»åŠ¡ | çŠ¶æ€ | è¯´æ˜Ž |
|------|------|------|
| T14: æ‰‹ç»­è´¹/æ»‘ç‚¹ UI | ðŸ“‹ | å‰ç«¯é…ç½®é¢æ¿ |
| T15: åˆå§‹èµ„é‡‘ UI | ðŸ“‹ | å‰ç«¯å¯é€‰è¾“å…¥ |

---

## 3. å®žæ–½é˜¶æ®µ (Implementation Phasing)

| é˜¶æ®µ | ä¸»é¢˜ | çŠ¶æ€ | æµ‹è¯• |
|------|------|------|------|
| 3.1 | æ•°æ®åº“åŸºç¡€è®¾æ–½ | âœ… å·²å®Œæˆ | 46 tests |
| 3.2 | æ•°æ®å¢žå¼ºä¸ŽæŒ‡æ ‡ | âœ… å·²å®Œæˆ | +30 tests |
| 3.3 | äº¤æ˜“å¼•æ“Žå¼ºåŒ– | âœ… å·²å®Œæˆ | +68 tests |
| 3.4 | ä¸šç»©è¯„ä»·ç³»ç»Ÿ | âœ… å·²å®Œæˆ | +21 tests |
| 3.5 | ç”¨æˆ·é…ç½®å¢žå¼º | âœ… å·²å®Œæˆ | +4 tests |
| 3.6 | å¯è§†åŒ–å¢žå¼º | âœ… å·²å®Œæˆ | T14-T15 |

**å½“å‰æµ‹è¯•ç»Ÿè®¡**: 470 tests passed, 4 skipped

---

## 4. Phase 3.5 ç”¨æˆ·é…ç½®å¢žå¼º (è¯¦ç»†è§„åˆ’)

### T12: åˆå§‹èµ„é‡‘è‡ªå®šä¹‰é…ç½®

**èƒŒæ™¯**: åˆå§‹èµ„é‡‘å½±å“ä»“ä½è®¡ç®—ï¼ˆPercentSize, RiskSizeï¼‰å’Œæ”¶ç›ŠçŽ‡è®¡ç®—ã€‚ç›®å‰ä»£ç å±‚æ”¯æŒï¼Œä½† API å’Œå‰ç«¯æœªæš´éœ²ã€‚

**å®žçŽ°è®¡åˆ’**:

1. **API å±‚** (`src/api/main.py`)
   ```python
   @app.post("/api/backtest/run")
   async def run_backtest(
       code: str,
       symbol: str,
       interval: str = "1h",
       days: int = 30,
       initial_capital: float = 100000.0,  # æ–°å¢žå‚æ•°
       commission_rate: float = 0.001,
       slippage: float = 0.0005
   ):
   ```

2. **å‰ç«¯** (`web/js/api.js`)
   - å¢žåŠ åˆå§‹èµ„é‡‘è¾“å…¥æ¡†
   - é»˜è®¤å€¼ 100,000

3. **éªŒè¯**
   - æœ€å°èµ„é‡‘é™åˆ¶ï¼ˆé˜²æ­¢ 0 æˆ–è´Ÿæ•°ï¼‰
   - æœ€å¤§èµ„é‡‘é™åˆ¶ï¼ˆé˜²æ­¢æº¢å‡ºï¼‰

---

## é™„å½•ï¼šå…³é”®æŠ€æœ¯å†³ç­–è¯´æ˜Ž

### D3: æ•°æ®åº“å¹¶å‘æ¨¡åž‹
> **å†³ç­–**: SQLite + WAL æ¨¡å¼ã€‚å…è®¸ä¸€ä¸ªå†™è€…ä¸é˜»å¡žå¤šä¸ªè¯»è€…ã€‚

### D4: çµæ´»ä»“ä½è®¡ç®—
> **å†³ç­–**: ç‹¬ç«‹ Sizer æŠ½è±¡å±‚ã€‚å°†"äº¤æ˜“ä»€ä¹ˆ"ä¸Ž"äº¤æ˜“å¤šå°‘"è§£è€¦ã€‚

### D5: å¤šå‘¨æœŸæ•°æ®å¯¹é½
> **å†³ç­–**: è‡ªé€‚åº”æ—¶é—´æˆ³åˆå¹¶ï¼Œä¸¥æ ¼æœç»æœªæ¥å‡½æ•°é£Žé™©ã€‚

---

## æ ¸å¿ƒæž¶æž„æ¼”è¿›å›¾

```mermaid
graph TB
    subgraph Config [ç”¨æˆ·é…ç½®å±‚]
        UI[å‰ç«¯é…ç½®é¢æ¿]
        API[API å‚æ•°]
    end

    subgraph Storage [æ•°æ®å­˜å‚¨å±‚]
        DB[(SQLite)]
        Repo[MarketDataRepository]
    end

    subgraph Engine [å›žæµ‹å¼•æ“Ž]
        Broker[ç»çºªå•†æ ¸å¿ƒ]
        Sizer[Sizer èµ„é‡‘ç®¡ç†]
        Slippage[æ»‘ç‚¹æ¨¡åž‹]
        Commission[æ‰‹ç»­è´¹æ¨¡åž‹]
        Analyzer[ä¸šç»©åˆ†æžå™¨]
    end

    UI --> API
    API --> Broker
    Repo --> Broker
    Broker --> Sizer
    Broker --> Slippage
    Broker --> Commission
    Broker --> Analyzer
```
