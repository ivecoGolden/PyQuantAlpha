# Phase 2 å¼€å‘è·¯çº¿å›¾ï¼šæ ¸å¿ƒå›æµ‹èƒ½åŠ›å‡çº§

## 1. ç›®æ ‡æ¦‚è¿° (Overview)

Phase 2 çš„æ ¸å¿ƒç›®æ ‡æ˜¯å°† PyQuantAlpha ä»ä¸€ä¸ª "AI æ¼”ç¤ºå·¥å…·" å‡çº§ä¸ºå…·å¤‡ "å®æˆ˜éªŒè¯èƒ½åŠ›" çš„é‡åŒ–å›æµ‹å¼•æ“ã€‚
**ä¼˜å…ˆçº§è°ƒæ•´**ï¼šæ ¹æ®è®¨è®ºï¼Œæˆ‘ä»¬å°†ä¼˜å…ˆå®Œå–„ **æ—¥å¿—ä¸å¯è§†åŒ–** èƒ½åŠ›ï¼Œä»¥ä¾¿äºæ›´å¥½åœ°è§‚æµ‹ç­–ç•¥è¡Œä¸ºï¼›éšåå»ºç«‹ **é«˜çº§è®¢å•ç³»ç»Ÿ** å¼¥è¡¥é£æ§ç¼ºå¤±ï¼›æœ€åè¿›è¡Œåº•å±‚æ¶æ„å‡çº§ä»¥æ”¯æŒ **å¤šèµ„äº§æ¨¡å¼**ã€‚

## 2. æ ¸å¿ƒåŠŸèƒ½è§„åˆ’ (Core Features)

### 2.1 [P0] å¢å¼ºå‹æ—¥å¿—ä¸å¯è§†åŒ– (Logging & Visualization)
**å‚è€ƒ**ï¼šBacktrader çš„ `Writer` å’Œ `Observer` æœºåˆ¶åŠ `notify_order` å›è°ƒã€‚
**ç°çŠ¶**ï¼šä»…è®°å½•å‡€å€¼æ›²çº¿ï¼Œæ— æ³•çŸ¥é“å…·ä½“çš„æˆäº¤æ—¶é—´ã€ä»·æ ¼å’Œè´¹ç”¨ã€‚
**ç›®æ ‡**ï¼šå®ç°â€œé€æ˜åŒ–å›æµ‹â€ï¼Œæ‰€æœ‰åŠ¨ä½œå¯è¿½æº¯ï¼Œå¹¶åœ¨å‰ç«¯å›¾è¡¨ä¸Šæ ‡è®°ã€‚

- **[T1] ç­–ç•¥å›è°ƒé’©å­ (Strategy Hooks)**
    - å®ç° `notify_order(order)`ï¼šå½“è®¢å•çŠ¶æ€æ”¹å˜ï¼ˆæäº¤ã€æˆäº¤ã€å–æ¶ˆï¼‰æ—¶è§¦å‘ã€‚
    - å®ç° `notify_trade(trade)`ï¼šå½“ä¸€ç¬”å®Œæ•´çš„äº¤æ˜“ï¼ˆå¼€ä»“+å¹³ä»“ï¼‰ç»“æŸæ—¶è§¦å‘ã€‚
    - å…è®¸ç­–ç•¥åœ¨è¿™äº›é’©å­ä¸­è‡ªå®šä¹‰ `print` æˆ– `log` è¡Œä¸ºã€‚
- **[T2] ç»“æ„åŒ–æ—¥å¿—å¢å¼º**
    - æ”¹é€  `BacktestLogger`ï¼Œå¢åŠ  `orders` å’Œ `trades` çš„è¯¦ç»†æµæ°´è®°å½•ã€‚
    - æ—¥å¿—å­—æ®µå¯¹é½ Backtraderï¼š`ref`, `type`, `size`, `price`, `comm`ã€‚
- **[T3] å¯è§†åŒ–æ•°æ®é€‚é…**
    - åœ¨ API è¿”å›çš„ JSON ä¸­åŒ…å« `markers` æ•°ç»„ï¼ˆä¹°å–ç‚¹ï¼‰ã€‚
    - å‰ç«¯ Highcharts ç»˜åˆ¶ Buy(ç»¿è‰²ä¸‰è§’å½¢) å’Œ Sell(çº¢è‰²ä¸‰è§’å½¢) æ ‡è®°ã€‚

### 2.2 [P1] äº¤æ˜“æ ¸å¿ƒé‡æ„ (Core Trading Engine)
**å‚è€ƒ**ï¼šBacktrader çš„ `Broker` æŠ½è±¡ä¸å®Œæ•´è®¢å•ç”Ÿå‘½å‘¨æœŸã€‚
**ç°çŠ¶**ï¼šæ’®åˆé€»è¾‘è€¦åˆåœ¨ Engine ä¸­ï¼Œä»…æ”¯æŒå¸‚ä»·/é™ä»·ï¼ŒçŠ¶æ€ç®€å•ã€‚
**ç›®æ ‡**ï¼šè§£è€¦äº¤æ˜“æ‰§è¡Œå±‚ï¼Œæ”¯æŒå¤æ‚è®¢å•ä¸æ›´çœŸå®çš„èµ„é‡‘ç®¡ç†ã€‚

- **[T4] å¼•å…¥ Broker æŠ½è±¡å±‚**
    - **æ¶æ„å‡çº§**ï¼šä» `Engine` ä¸­å‰¥ç¦»äº¤æ˜“é€»è¾‘ï¼Œå»ºç«‹ `BacktestBroker` ç±»ã€‚
    - **èŒè´£**ï¼šæ¥ç®¡èµ„é‡‘ (`cash`, `value`)ã€æŒä»“ (`positions`) ç®¡ç†åŠè®¢å•æ’®åˆ (`_match_orders`)ã€‚
    - **æ„ä¹‰**ï¼šä¸ºæœªæ¥å¯¹æ¥å®ç›˜äº¤æ˜“ï¼ˆLive Tradingï¼‰é¢„ç•™æ¥å£ï¼Œå®ç°é€»è¾‘è§£è€¦ã€‚
- **[T5] å®Œå–„è®¢å•ç”Ÿå‘½å‘¨æœŸ**
    - **çŠ¶æ€æœºå‡çº§**ï¼šå¼•å…¥å®Œæ•´çŠ¶æ€ `Submitted` -> `Accepted` -> `Partial` -> `Completed` / `Canceled` / `Rejected` (èµ„é‡‘ä¸è¶³)ã€‚
    - **é£æ§è®¢å•**ï¼šå®ç° `STOP` (æ­¢æŸ) å’Œ `STOP_LIMIT` (æ­¢æŸé™ä»·) è®¢å•ã€‚
    - **è§¦å‘æœºåˆ¶**ï¼šå€Ÿé‰´ BTï¼Œä¸¥æ ¼åŒºåˆ† "Triggered" (è§¦å‘) ä¸ "Executed" (æˆäº¤)ã€‚
- **[T6] èµ„é‡‘ç®¡ç†é¢„ç•™ (Sizer)**
    - åœ¨ `Order` æ¥å£ä¸­é¢„ç•™è‡ªåŠ¨è®¡ç®—æ•°é‡çš„é€»è¾‘ï¼ˆå¦‚ `size=None` æ—¶æŒ‰èµ„é‡‘ç™¾åˆ†æ¯”ä¸‹å•ï¼‰ï¼Œä¸ºæœªæ¥å¼•å…¥ `Sizer` æ¨¡å—åšå‡†å¤‡ã€‚

### 2.3 [P2] æ¶æ„ä¼˜åŒ–ä¸å¤šèµ„äº§å¼•æ“ (Architecture & Multi-Asset)

**ç›®æ ‡**ï¼šè§£è€¦æ¨¡å—ä¾èµ–ï¼Œæ”¯æŒå¤šèµ„äº§æ•°æ®æµï¼Œæå‡å¼•æ“æ‰©å±•æ€§ã€‚

#### Phase 2.3a: æ¶æ„é‡æ„ (Architecture Refactoring) [âœ… å·²å®Œæˆ]
- **[T6] ä¾èµ–è§£è€¦**:
    - åˆ›å»º `loader.py`ï¼Œç§»é™¤ `backtest` å¯¹ `ai` æ¨¡å—çš„ä¾èµ–å€’ç½®ã€‚
    - åˆ›å»º `strategy.py` åŸºç±»ï¼Œæä¾› IDE ç±»å‹æç¤ºã€‚
- **[T7] æ•°æ®æºæŠ½è±¡**:
    - å¼•å…¥ `DataFeed`ã€`SingleFeed`ã€`MultiFeed` æŠ½è±¡ã€‚
    - ä¼˜åŒ– `Broker` è®¢å•æŸ¥æ‰¾æ€§èƒ½ä¸º O(1)ã€‚

#### Phase 2.3b: å¤šèµ„äº§ç­–ç•¥é€‚é… (Multi-Asset Adaptation) [ğŸš§ å¾…åŠ]
**å‚è€ƒ**ï¼šBacktrader çš„ `Cerebro` æ•°æ®å¯¹é½ä¸ `Lines` ç´¢å¼•ã€‚
**ç°çŠ¶**ï¼šå·²åŒ…å« `MultiFeed` ç±»ï¼Œä½†ä»…æ”¯æŒå†…è¿æ¥å¯¹é½ï¼›Engine å°šæœªé€‚é…å¤šèµ„äº§å­—å…¸è¾“å…¥ã€‚

- **[T8] é«˜çº§æ•°æ®å¯¹é½**:
    - **å®ç°æ–¹æ¡ˆ**: å‡çº§ `MultiFeed` å¯¹é½é€»è¾‘ï¼Œä»å†…è¿æ¥æ”¹ä¸º **å¹¶é›†æ—¶é—´è½´ + å‰å€¼å¡«å…… (Forward Fill)**ã€‚
- **[T9] å¼•æ“ä¸ API å‡çº§**:
    - **Engine**: è¯†åˆ« `MultiFeed` è¾“å…¥ï¼Œé€‚é… `run` å¾ªç¯ã€‚
    - **Strategy**: å¼•å…¥ `on_bars(self, bars: Dict)` æˆ–æ›´æ–° `on_bar` å¤„ç†é€»è¾‘ã€‚
    - **Prompt**: æ›´æ–° AI æç¤ºè¯ï¼Œæ•™å¯¼ç”Ÿæˆå¤šèµ„äº§ç­–ç•¥ï¼ˆå¦‚é…å¯¹äº¤æ˜“ï¼‰ã€‚

---

## 3. å®æ–½é˜¶æ®µ (Implementation Phasing)

1.  **Phase 2.1 (Logging)** [âœ… å®Œæˆ]: å¢å¼ºæ—¥å¿—ç³»ç»Ÿï¼Œæ”¯æŒå‰ç«¯å¯è§†åŒ–ã€‚
2.  **Phase 2.2 (Core Trading)** [âœ… å®Œæˆ]: æå– `BacktestBroker`ï¼Œå®ç°é«˜çº§è®¢å•ç±»å‹ã€‚
3.  **Phase 2.3a (Architecture)** [âœ… å®Œæˆ]: æ•°æ®æºæŠ½è±¡ä¸æ¨¡å—è§£è€¦ã€‚
4.  **Phase 2.3b (Multi-Asset)** [ğŸš§ å¾…åŠ]: å¤šèµ„äº§å¯¹é½ä¸ API å‡çº§ã€‚

---

## é™„å½•ï¼šå…³é”®æŠ€æœ¯å†³ç­–è¯´æ˜ (Technical Decisions Appendix)

### D1: æ•°æ®å¯¹é½ç­–ç•¥ (Data Alignment Strategy)
> **å†³ç­–**ï¼šé‡‡ç”¨ **å¹¶é›†æ—¶é—´è½´ (Union Timestamps) + å‰å€¼å¡«å…… (Forward Fill)** æœºåˆ¶ã€‚
> **èƒŒæ™¯**ï¼šåœ¨å¤šèµ„äº§æ¨¡å¼ä¸‹ï¼Œä¸åŒäº¤æ˜“å¯¹ï¼ˆå¦‚ BTC å’Œ ETHï¼Œæˆ–ä¸åŒäº¤æ˜“æ‰€æ•°æ®ï¼‰çš„æ—¶é—´æˆ³å¯èƒ½æ— æ³•å®Œå…¨å¯¹é½ï¼ˆä¾‹å¦‚æŸåˆ†é’Ÿæ²¡æœ‰æˆäº¤ï¼‰ã€‚
> **è§£é‡Š**ï¼š
> 1.  å¼•æ“ä¼šå…ˆè®¡ç®—æ‰€æœ‰è¾“å…¥æ•°æ®æºçš„æ—¶é—´æˆ³å¹¶é›†ï¼Œç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„ä¸»æ—¶é—´è½´ã€‚
> 2.  æŒ‰æ—¶é—´é¡ºåºæ¨è¿›æ—¶ï¼Œå¦‚æœæŸä¸ªå¸ç§åœ¨å½“å‰æ—¶é—´ç‚¹ç¼ºå¤±æ•°æ®ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨å…¶ **ä¸Šä¸€æ ¹æœ‰æ•ˆ K çº¿** çš„æ•°æ®è¿›è¡Œå¡«å……ï¼ˆå³è®¤ä¸ºä»·æ ¼ç»´æŒä¸å˜ï¼‰ã€‚
> 3.  è¿™æ¨¡æ‹Ÿäº†çœŸå®äº¤æ˜“ç¯å¢ƒï¼šå³ä½¿æŸä¸ªå¸‚åœºæš‚æ—¶æ²‰å¯‚ï¼Œä½ ä¾ç„¶å¯ä»¥æ ¹æ®å…¶ä»–å¸‚åœºçš„å˜åŠ¨æ¥æ“ä½œè¯¥å¸‚åœºçš„æŒä»“ã€‚

### D2: API å…¼å®¹æ€§ (API Compatibility)
> **å†³ç­–**ï¼šé‡‡ç”¨ **ä¸å…¼å®¹å‡çº§ (Breaking Change)**ï¼Œé‡æ„ `on_bar` æ¥å£ã€‚
> **èƒŒæ™¯**ï¼šç°æœ‰çš„ `on_bar(bar)` ä»…æ”¯æŒå•èµ„äº§ï¼Œè‹¥è¦æ”¯æŒå¤šèµ„äº§ï¼Œå­˜åœ¨"é€šè¿‡ä»£ç†å¯¹è±¡ç»´æŒå…¼å®¹"å’Œ"ç›´æ¥æ”¹ä¸ºå­—å…¸"ä¸¤ç§è·¯çº¿ã€‚
> **è§£é‡Š**ï¼š
> 1.  æˆ‘ä»¬é€‰æ‹© **ç›´æ¥æ”¹ä¸ºå­—å…¸ `on_bar(bars: Dict[str, Bar])`**ã€‚
> 2.  è™½ç„¶è¿™ä¼šç ´åæ—§ç­–ç•¥çš„å…¼å®¹æ€§ï¼ˆæ—§ç­–ç•¥éœ€ä¿®æ”¹ä»£ç ï¼‰ï¼Œä½†å®ƒæ¶ˆé™¤äº†ä»£ç å±‚é¢çš„æ­§ä¹‰ï¼ˆAmbiguityï¼‰ã€‚
> 3.  åœ¨å¼€å‘é˜¶æ®µæ˜ç¡®æ•°æ®ç»“æ„ä¼˜äºé€šè¿‡ Magic Methods éšè—å¤æ‚æ€§ï¼Œæœ‰åˆ©äºé•¿æœŸç»´æŠ¤å’Œ AI ç”Ÿæˆä»£ç çš„å‡†ç¡®æ€§ã€‚

## æ•´ä½“ç»“æ„å›¾

```mermaid
graph LR
    %% æ ·å¼å®šä¹‰ - ä½¿ç”¨é«˜å¯¹æ¯”åº¦é¢œè‰²æ­é…ç™½è‰²æ–‡å­—
    classDef front fill:#1976D2,stroke:#0D47A1,stroke-width:2px,color:white;
    classDef api fill:#F57C00,stroke:#E65100,stroke-width:2px,color:white;
    classDef ai fill:#7B1FA2,stroke:#4A148C,stroke-width:2px,color:white;
    classDef backtest fill:#388E3C,stroke:#1B5E20,stroke-width:2px,color:white;
    classDef data fill:#546E7A,stroke:#263238,stroke-width:2px,color:white;

    %% å‰ç«¯å±‚ (å·¦ä¾§å…¥å£)
    subgraph Frontend [å‰ç«¯äº¤äº’å±‚]
        direction TB
        UI["ç½‘é¡µå‰ç«¯ (HTML/CSS)"]:::front
        JS["åº”ç”¨é€»è¾‘ (Vue/JS)"]:::front
        UI -->|ç”¨æˆ·æ“ä½œ| JS
    end

    %% API å±‚ (ä¸­é—´ç½‘å…³)
    subgraph API [API æœåŠ¡å±‚]
        direction TB
        FastAPI["FastAPI ä¸»ç¨‹åº"]:::api
        Route_Strat["ç­–ç•¥æ¥å£è·¯ç”±"]:::api
        Route_Klines["è¡Œæƒ…æ¥å£è·¯ç”±"]:::api
        SSE["å®æ—¶æ¶ˆæ¯æµ (SSE)"]:::api
        
        FastAPI --> Route_Strat
        FastAPI --> Route_Klines
    end

    %% æ ¸å¿ƒä¸šåŠ¡æ¨¡å— (å³ä¾§å¹¶è¡Œ)
    subgraph Core [æ ¸å¿ƒä¸šåŠ¡æ¨¡å—]
        direction TB
        
        %% AI æ ¸å¿ƒ
        subgraph AICore [AI æ ¸å¿ƒæ¨¡å—]
            direction TB
            Factory["LLM å·¥å‚ç±»"]:::ai
            Client["AI å®¢æˆ·ç«¯"]:::ai
            Validator["å®‰å…¨æ ¡éªŒå™¨"]:::ai
            
            Factory -->Client
        end

        %% å›æµ‹å¼•æ“
        subgraph Backtest [å›æµ‹å¼•æ“æ¨¡å—]
            direction TB
            Manager["å›æµ‹ç®¡ç†å™¨ (å¼‚æ­¥)"]:::backtest
            Engine["å›æµ‹æ ¸å¿ƒå¼•æ“"]:::backtest
            Logger["å›æµ‹æ—¥å¿—"]:::backtest
            
            Manager -->|å¯åŠ¨| Engine
            Engine --> Logger
        end
    end

    %% æ•°æ®å±‚ (åº•å±‚æ”¯æ’‘)
    subgraph Data [æ•°æ®æœåŠ¡å±‚]
        Binance["äº¤æ˜“æ‰€å®¢æˆ·ç«¯"]:::data
        Bar["Kçº¿æ•°æ®"]:::data
        Binance -.-> Bar
    end

    %% è·¨å±‚è¿æ¥
    JS -->|REST API| FastAPI
    JS -->|EventStream| SSE

    %% è·¯ç”±åˆ†å‘
    Route_Strat -->|åˆ›å»º| Factory
    Route_Strat -->|æ ¡éªŒ| Validator
    Route_Strat -->|å¯åŠ¨ä»»åŠ¡| Manager
    
    Route_Klines --> Binance
    
    %% æµç¨‹è¿æ¥
    Client -->|è¿”å›ä»£ç | Validator
    Manager -->|æ¨é€äº‹ä»¶| SSE
    Engine -->|è¯·æ±‚æ•°æ®| Binance

    %% å¸ƒå±€è°ƒæ•´
    Frontend --> API
    API --> Core
    Core --> Data
```