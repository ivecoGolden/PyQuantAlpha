<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyQuantAlpha ç­–ç•¥ç”Ÿæˆå®éªŒå®¤</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .markdown-body pre {
            background-color: #0d1117;
            padding: 1em;
            border-radius: 6px;
            overflow-x: auto;
        }

        .markdown-body code {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite;
            /* Safari */
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen p-8">

    <div class="max-w-6xl mx-auto">
        <header class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ¤– PyQuantAlpha ç­–ç•¥ç”Ÿæˆå®éªŒå®¤</h1>
                <p class="text-gray-600">è¾“å…¥æ‚¨çš„ç­–ç•¥æƒ³æ³•ï¼ŒAI å°†è‡ªåŠ¨ç¼–å†™ Python ä»£ç ã€‚</p>
            </div>
            <div id="api-status" class="px-3 py-1 rounded-full text-sm font-medium bg-gray-200 text-gray-600">
                æ£€æŸ¥ API è¿æ¥...
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: Input -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit">
                <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2">ç­–ç•¥æè¿°</label>
                <textarea id="prompt" rows="12"
                    class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none mb-4"
                    placeholder="ä¾‹å¦‚ï¼šåˆ›å»ºåŒå‡çº¿ç­–ç•¥ï¼Œå½“ 20 æ—¥å‡çº¿ä¸Šç©¿ 60 æ—¥å‡çº¿æ—¶ä¹°å…¥ï¼Œä¸‹ç©¿æ—¶å–å‡ºã€‚æ­¢æŸè®¾ç½® 5%..."></textarea>

                <button id="generate-btn" onclick="generateStrategy()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="btn-text">ğŸš€ ç”Ÿæˆç­–ç•¥ä»£ç </span>
                </button>
            </div>

            <!-- Right Column: Output -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 min-h-[500px]">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">ç”Ÿæˆç»“æœ</h2>
                    <button id="copy-btn" onclick="copyCode()"
                        class="hidden text-sm text-blue-600 hover:text-blue-800 font-medium">
                        å¤åˆ¶å¤šä»£ç 
                    </button>
                </div>

                <div id="result-area" class="prose prose-sm max-w-none markdown-body text-gray-700">
                    <div class="flex flex-col items-center justify-center h-64 text-gray-400">
                        <svg class="w-12 h-12 mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                        </svg>
                        <p>ç”Ÿæˆçš„ä»£ç å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';

        // æ£€æŸ¥ API çŠ¶æ€
        checkHealth();

        async function checkHealth() {
            const statusEl = document.getElementById('api-status');
            try {
                // Health check is at /health (root level router)
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    statusEl.textContent = 'API è¿æ¥æ­£å¸¸ ğŸŸ¢';
                    statusEl.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
                } else {
                    throw new Error('API Error');
                }
            } catch (e) {
                statusEl.textContent = 'API è¿æ¥å¤±è´¥ ğŸ”´';
                statusEl.className = 'px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
            }
        }

        async function generateStrategy() {
            const prompt = document.getElementById('prompt').value.trim();
            const btn = document.getElementById('generate-btn');
            const btnText = document.getElementById('btn-text');
            const resultArea = document.getElementById('result-area');
            const copyBtn = document.getElementById('copy-btn');

            if (!prompt) {
                alert('è¯·è¾“å…¥ç­–ç•¥æè¿°');
                return;
            }

            // Loading state
            btn.disabled = true;
            btnText.innerHTML = '<span class="loader"></span> AI æ­£åœ¨æ€è€ƒ...';
            resultArea.innerHTML = '<div class="animate-pulse space-y-4"><div class="h-4 bg-gray-200 rounded w-3/4"></div><div class="h-4 bg-gray-200 rounded"></div><div class="h-4 bg-gray-200 rounded"></div><div class="h-64 bg-gray-100 rounded"></div></div>';
            copyBtn.classList.add('hidden');

            try {
                // Generate endpoint is at /api/generate
                const response = await fetch(`${API_BASE}/api/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt: prompt })
                });

                const data = await response.json();

                if (response.ok) {
                    // æ¸²æŸ“ Markdown
                    // æˆ‘ä»¬æŠŠ Python ä»£ç åŒ…è£…åœ¨ ```python ... ``` ä¸­ä»¥ç¡®ä¿ markdown æ¸²æŸ“æ­£ç¡®ï¼Œ
                    // è™½ç„¶ API å¯èƒ½åªè¿”å›ä»£ç ï¼Œä½†ä¸ºäº†ä¿é™©æˆ‘ä»¬å¤„ç†ä¸€ä¸‹
                    let content = data.code;
                    if (!content.startsWith('```')) {
                        content = '```python\n' + content + '\n```';
                    }

                    if (!data.is_valid) {
                        content = `> [!WARNING]\n> ${data.message}\n\n` + content;
                    } else {
                        content = `> [!NOTE]\n> ${data.message}\n\n` + content;
                    }

                    resultArea.innerHTML = marked.parse(content);

                    // é«˜äº®ä»£ç 
                    document.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });

                    copyBtn.classList.remove('hidden');
                    window.generatedCode = data.code; // ä¿å­˜ä»¥ä¾›å¤åˆ¶ state

                } else {
                    resultArea.innerHTML = `<div class="p-4 rounded-lg bg-red-50 text-red-700">
                        <h4 class="font-bold mb-2">ç”Ÿæˆå¤±è´¥</h4>
                        <p>${data.detail || 'æœªçŸ¥é”™è¯¯'}</p>
                    </div>`;
                }
            } catch (e) {
                resultArea.innerHTML = `<div class="p-4 rounded-lg bg-red-50 text-red-700">
                    <h4 class="font-bold mb-2">ç½‘ç»œé”™è¯¯</h4>
                    <p>${e.message}</p>
                    <p class="text-sm mt-2">è¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨: uvicorn src.api.main:app --reload --cors</p>
                </div>`;
            } finally {
                btn.disabled = false;
                btnText.textContent = 'ğŸš€ ç”Ÿæˆç­–ç•¥ä»£ç ';
            }
        }

        function copyCode() {
            if (window.generatedCode) {
                navigator.clipboard.writeText(window.generatedCode).then(() => {
                    const originalText = document.getElementById('copy-btn').textContent;
                    document.getElementById('copy-btn').textContent = 'å·²å¤åˆ¶!';
                    setTimeout(() => {
                        document.getElementById('copy-btn').textContent = originalText;
                    }, 2000);
                });
            }
        }
    </script>
</body>

</html>