# PyQuantAlpha 端到端测试报告

> 生成时间: 2025-12-26 16:25:26


## 1. 输入的自然语言



```
请生成一个专业级量化交易策略，**必须使用以下所有新功能**：

## 1. 多指标融合体系
- 使用 EMA(20) 和 EMA(60) 构建趋势判断系统
- 使用 RSI(14) 判断超买超卖区域
- 使用 ATR(14) 计算动态止损止盈距离
- 使用 BollingerBands(20, 2.0) 判断价格相对位置

## 2. 入场条件（必须同时满足多个条件）
- 做多条件：EMA20 > EMA60（趋势向上）且 RSI < 40（超卖）且价格触及布林带下轨
- 做空条件：EMA20 < EMA60（趋势向下）且 RSI > 60（超买）且价格触及布林带上轨

## 3. 重要：仓位管理（必须使用 setsizer）
**必须在 init() 中调用以下代码之一：**
- `self.setsizer("risk", risk_percent=2, atr_multiplier=2)` - 基于 ATR 风险控制仓位
- 或 `self.setsizer("percent", percent=10)` - 按账户净值百分比计算

## 4. 重要：高级订单类型（必须使用以下之一）

### 方案 A：使用挂钩订单 (Bracket Order)
```python
# 买入时自动创建止损+止盈订单
self.buy_bracket("BTCUSDT", size=quantity, stopprice=stop_price, limitprice=take_profit)
```

### 方案 B：使用移动止损 (Trailing Stop)
```python
# 持仓后创建移动止损
self.trailing_stop("BTCUSDT", size=quantity, trailpercent=0.03)  # 3% 追踪
```

## 5. 交易回调（必须实现）
- `notify_order(self, order)` - 打印订单状态
- `notify_trade(self, trade)` - 打印交易盈亏

## 6. 交易对
交易对：BTCUSDT

## 重要提示
- 必须使用 `self.setsizer()` 设置仓位管理
- 必须使用 `self.buy_bracket()` 或 `self.sell_bracket()` 或 `self.trailing_stop()`
- 这些是平台的新功能，请务必使用
```


## 2. LLM 生成的策略代码



### 策略信息



| 属性 | 值 |
| --- | --- |
| LLM Provider | deepseek |
| 响应类型 | strategy |
| 交易对 | BTCUSDT |
| 代码长度 | 3628 字符 |
| 代码行数 | 91 行 |


### 完整代码



```python
class Strategy:
    def init(self):
        # 初始化技术指标
        self.ema20 = EMA(20)
        self.ema60 = EMA(60)
        self.rsi = RSI(14)
        self.bb = BollingerBands(20, 2.0)
        self.atr = ATR(14)
        
        # 设置基于ATR的风险仓位管理，每次交易最大风险为账户净值的2%，ATR乘数为2
        self.setsizer("risk", risk_percent=2, atr_multiplier=2)
        
        # 交易状态跟踪
        self.in_position = False
        self.current_side = None  # 记录当前持仓方向："LONG" 或 "SHORT"
    
    def on_bar(self, data):
        # 获取当前Bar数据（单资产模式，data是Bar对象）
        bar = data
        if not bar:
            return
        
        # 更新指标
        close_price = bar.close
        high_price = bar.high
        low_price = bar.low
        
        ema20_val = self.ema20.update(close_price)
        ema60_val = self.ema60.update(close_price)
        rsi_val = self.rsi.update(close_price)
        bb_res = self.bb.update(close_price)
        atr_val = self.atr.update(high_price, low_price, close_price)
        
        # 检查指标是否就绪（避免初始阶段None值）
        if ema20_val is None or ema60_val is None or rsi_val is None or bb_res is None or atr_val is None:
            return
        
        # 获取布林带上下轨
        bb_upper = bb_res.upper
        bb_lower = bb_res.lower
        
        # 检查是否有持仓
        position = self.get_position("BTCUSDT")
        if position:
            self.in_position = True
            self.current_side = "LONG" if position.quantity > 0 else "SHORT"
        else:
            self.in_position = False
            self.current_side = None
        
        # 如果没有持仓，检查入场条件
        if not self.in_position:
            # 做多条件：EMA20 > EMA60（趋势向上）且 RSI < 40（超卖）且价格触及布林带下轨
            if ema20_val > ema60_val and rsi_val < 40 and close_price <= bb_lower:
                # 计算止损和止盈价格（基于ATR）
                stop_price = close_price - 2 * atr_val  # 止损距离为2倍ATR
                take_profit_price = close_price + 3 * atr_val  # 止盈距离为3倍ATR
                
                # 使用挂钩订单入场做多（自动设置止损和止盈）
                self.buy_bracket("BTCUSDT", size=None, stopprice=stop_price, limitprice=take_profit_price)
                
            # 做空条件：EMA20 < EMA60（趋势向下）且 RSI > 60（超买）且价格触及布林带上轨
            elif ema20_val < ema60_val and rsi_val > 60 and close_price >= bb_upper:
                # 计算止损和止盈价格（基于ATR）
                stop_price = close_price + 2 * atr_val  # 止损距离为2倍ATR
                take_profit_price = close_price - 3 * atr_val  # 止盈距离为3倍ATR
                
                # 使用挂钩订单入场做空（自动设置止损和止盈）
                self.sell_bracket("BTCUSDT", size=None, stopprice=stop_price, limitprice=take_profit_price)
        
        # 如果有持仓，可以添加其他管理逻辑（例如移动止损），但挂钩订单已自动处理止损止盈
        # 这里可以选择添加移动止损作为额外保护，但为了简洁，我们主要依赖挂钩订单
        # 如果需要，可以取消注释以下代码添加移动止损（例如3%追踪）
        # if self.in_position and self.current_side == "LONG":
        #     self.trailing_stop("BTCUSDT", size=None, trailpercent=0.03)
        # elif self.in_position and self.current_side == "SHORT":
        #     self.trailing_stop("BTCUSDT", size=None, trailpercent=0.03)
    
    def notify_order(self, order):
        # 打印订单状态信息
        if order.status == "FILLED":
            print(f"订单成交: 订单ID {order.id}, 交易对 {order.symbol}, 方向 {order.side}, 价格 {order.price}, 数量 {order.quantity}")
        elif order.status == "REJECTED":
            print(f"订单被拒绝: 订单ID {order.id}, 交易对 {order.symbol}")
        elif order.status == "CANCELLED":
            print(f"订单已取消: 订单ID {order.id}, 交易对 {order.symbol}")
    
    def notify_trade(self, trade):
        # 打印交易盈亏信息
        if trade.pnl != 0:
            print(f"交易平仓: 交易对 {trade.symbol}, 盈亏 {trade.pnl}, 手续费 {trade.fee}, 时间 {trade.timestamp}")
```


### 代码验证

✅ 验证通过

## 3. 市场数据



| 属性 | 值 |
| --- | --- |
| 交易对 | BTCUSDT |
| K线数量 | 1440 根 |
| 时间范围 | 2025-10-27 17:00:00 ~ 2025-12-26 16:00:00 |
| 价格范围 | $80600.00 ~ $116086.00 |


## 4. 交易日志



| 时间 | 交易对 | 方向 | 数量 | 价格 | PnL | 手续费 |
| --- | --- | --- | --- | --- | --- | --- |
| 2025-11-19 01:00 | BTCUSDT | SELL | 1.0072 | $93210.29 | $0.00 | $93.88 |
| 2025-11-19 13:00 | BTCUSDT | BUY | 1.0072 | $90520.64 | $+2709.05 | $91.17 |


### 交易统计



| 指标 | 值 |
| --- | --- |
| 总交易次数 | 2 |
| 买入次数 | 1 |
| 卖出次数 | 1 |
| 盈利交易 | 1 |
| 亏损交易 | 0 |
| 总手续费 | $185.06 |
| 平均盈利 | $2709.05 |
| 最大单笔盈利 | $2709.05 |


## 5. 回测结果



### 核心指标



| 指标 | 值 |
| --- | --- |
| 总收益率 | 2.52% |
| 年化收益率 | 0.63% |
| 最大回撤 | 47.65% |
| 夏普比率 | 0.19 |
| 胜率 | 100.00% |
| 盈亏比 | inf |
| 总交易次数 | 2 |


### 净值分析



| 指标 | 值 |
| --- | --- |
| 初始净值 | $100,000.00 |
| 最终净值 | $102,523.99 |
| 最高净值 | $195,850.58 |
| 最低净值 | $100,000.00 |
| 净值波动 | $95,850.58 |


## 耗时统计



| 环节 | 耗时 |
| --- | --- |
| LLM 初始化 | 0.54s |
| LLM 策略生成 | 55.40s |
| 代码验证 | 0.00s |
| 获取市场数据 | 3.75s |
| 回测执行 | 0.03s |
| **总耗时** | **59.72s** |


## 7. 测试环境



| 项目 | 值 |
| --- | --- |
| Python 版本 | 3.13.10 |
| LLM Provider | deepseek |
| 初始资金 | $100,000.00 |
| 手续费率 | 0.10% |
| 滑点 | 0.0500% |
| 数据周期 | 1h |
| 回测天数 | 60 |


## 8. 策略评分



**总评分: 95/100**

- ✅ 成功产生交易

- ✅ 总收益为正 (2.52%)

- ✅ 胜率高于 50% (100.0%)

- ✅ 最大回撤可控 (47.65%)

- ⚠️ 夏普比率一般 (0.19)
